# User Onboarding Pipeline
# A comprehensive workflow demonstrating validation, HTTP calls, transforms, emails, and logging
name: user-onboarding
version: 1.0.0
description: Complete user onboarding with validation, API calls, data transformation, and notifications

inputs:
  user:
    email: "john.doe@example.com"
    name: "John Doe"
    plan: "premium"
    company: "Acme Corp"
    referralCode: "REF123"

steps:
  # Step 1: Validate user input with multiple rules
  - id: validate_user
    activity: validate
    input:
      data: "{{inputs.user}}"
      rules:
        required: ["email", "name", "plan"]
        types:
          email: "string"
          name: "string"
          plan: "string"
        patterns:
          email: "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
        custom: "data.plan === 'free' || data.plan === 'premium' || data.plan === 'enterprise'"

  # Step 2: Check if user already exists via API
  - id: check_existing_user
    activity: http
    dependsOn: ["validate_user"]
    when: "{{step.validate_user.result.isValid}}"
    input:
      url: "https://api.example.com/users/check"
      method: "POST"
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer {{inputs.apiToken}}"
      body:
        email: "{{inputs.user.email}}"
      timeout: 10000
    retry:
      count: 2
      initialInterval: 1s

  # Step 3: Process user data with code node
  - id: process_user_data
    type: code
    dependsOn: ["check_existing_user"]
    when: "{{step.check_existing_user.result.data.exists}} == false"
    input:
      userData: "{{inputs.user}}"
      checkResult: "{{step.check_existing_user.result}}"
    code: |
      const user = {
        ...input.userData,
        id: crypto.randomUUID(),
        createdAt: new Date().toISOString(),
        status: 'pending_verification',
        tier: input.userData.plan === 'enterprise' ? 'vip' : 'standard',
        metadata: {
          source: 'onboarding_workflow',
          referral: input.userData.referralCode || null,
          ipAddress: '192.168.1.1'
        }
      };
      
      console.log('Processing user:', user.email);
      console.log('Assigned tier:', user.tier);
      
      return { user, isNew: true, processedAt: new Date().toISOString() };

  # Step 4: Transform data for CRM integration
  - id: prepare_crm_data
    activity: transform
    dependsOn: ["process_user_data"]
    input:
      data: "{{step.process_user_data.result}}"
      operations:
        - type: pick
          config:
            fields: ["user"]
        - type: rename
          config:
            mapping:
              user: "contact"

  # Step 5: Create user in external CRM
  - id: create_crm_contact
    activity: http
    dependsOn: ["prepare_crm_data"]
    input:
      url: "https://crm.example.com/api/contacts"
      method: "POST"
      headers:
        Content-Type: "application/json"
        X-API-Key: "{{inputs.crmApiKey}}"
      body: "{{step.prepare_crm_data.result.data}}"
      timeout: 15000
    retry:
      count: 3
      initialInterval: 2s
      backoffCoefficient: 2.0

  # Step 6: Send welcome email
  - id: send_welcome_email
    activity: email
    dependsOn: ["process_user_data"]
    input:
      to: "{{inputs.user.email}}"
      subject: "Welcome to Our Platform, {{inputs.user.name}}!"
      body: |
        <h1>Welcome, {{inputs.user.name}}!</h1>
        <p>Thank you for joining us. Your account has been created successfully.</p>
        <p><strong>Plan:</strong> {{inputs.user.plan}}</p>
        <p><strong>Company:</strong> {{inputs.user.company}}</p>
        <p>Please verify your email to get started.</p>
        <a href="https://example.com/verify?token={{step.process_user_data.result.user.id}}">Verify Email</a>

  # Step 7: Log successful onboarding
  - id: log_onboarding_success
    activity: log
    dependsOn: ["send_welcome_email", "create_crm_contact"]
    input:
      message: "User onboarding completed successfully"
      level: "info"
      data:
        userId: "{{step.process_user_data.result.user.id}}"
        email: "{{inputs.user.email}}"
        plan: "{{inputs.user.plan}}"
        crmSynced: true

  # Step 8: Wait for email verification (signal step)
  - id: await_email_verification
    type: signal
    dependsOn: ["send_welcome_email"]

  # Step 9: Activate account after verification
  - id: activate_account
    type: code
    dependsOn: ["await_email_verification"]
    when: "{{step.await_email_verification.result.verified}} == true"
    input:
      user: "{{step.process_user_data.result.user}}"
      verificationData: "{{step.await_email_verification.result}}"
    code: |
      const activatedUser = {
        ...input.user,
        status: 'active',
        verifiedAt: new Date().toISOString(),
        verificationMethod: input.verificationData.method || 'email'
      };
      
      console.log('Account activated for:', activatedUser.email);
      
      return { user: activatedUser, activatedAt: new Date().toISOString() };

  # Step 10: Send activation confirmation
  - id: send_activation_email
    activity: email
    dependsOn: ["activate_account"]
    input:
      to: "{{inputs.user.email}}"
      subject: "Your Account is Now Active!"
      body: |
        <h1>Account Activated!</h1>
        <p>Hi {{inputs.user.name}},</p>
        <p>Your account has been verified and is now fully active.</p>
        <p>Start exploring our platform today!</p>
        <a href="https://example.com/dashboard">Go to Dashboard</a>

  # Step 11: Schedule follow-up reminder
  - id: schedule_followup
    activity: wait
    dependsOn: ["send_activation_email"]
    input:
      duration: "24h"

  # Step 12: Send follow-up engagement email
  - id: send_followup_email
    activity: email
    dependsOn: ["schedule_followup"]
    input:
      to: "{{inputs.user.email}}"
      subject: "How's it going, {{inputs.user.name}}?"
      body: |
        <h1>We're Here to Help!</h1>
        <p>Hi {{inputs.user.name}},</p>
        <p>It's been 24 hours since you joined. How are you finding our platform?</p>
        <p>Here are some resources to help you get started:</p>
        <ul>
          <li><a href="https://example.com/docs">Documentation</a></li>
          <li><a href="https://example.com/tutorials">Video Tutorials</a></li>
          <li><a href="https://example.com/support">Contact Support</a></li>
        </ul>
