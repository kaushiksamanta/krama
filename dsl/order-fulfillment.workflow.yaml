name: order-fulfillment
version: 1.0.0
description: |
  Self-contained e-commerce order fulfillment workflow demonstrating
  validation, inventory management, payment, shipping, and notifications.

inputs:
  order:
    orderId: "ORD-2024-001234"
    customerId: "CUST-5678"
    items:
      - sku: "PROD-001"
        name: "Wireless Headphones"
        quantity: 2
        price: 79.99
      - sku: "PROD-002"
        name: "USB-C Cable"
        quantity: 3
        price: 12.99
    shippingAddress:
      street: "123 Main St"
      city: "San Francisco"
      state: "CA"
      zip: "94102"
      country: "US"
    paymentMethod:
      type: "credit_card"
      cardLast4: "4242"
    shippingMethod: "express"
  customerEmail: "customer@example.com"

steps:
  # Step 1: Validate order structure
  - id: validate_order
    activity: validate
    input:
      data: "{{inputs.order}}"
      rules:
        required: ["orderId", "customerId", "items", "shippingAddress", "paymentMethod"]
        types:
          orderId: "string"
          customerId: "string"
          items: "array"
        custom: "data.items && data.items.length > 0"

  # Step 2: Calculate order totals
  - id: calculate_totals
    type: code
    dependsOn: ["validate_order"]
    when: "{{step.validate_order.result.isValid}}"
    input:
      order: "{{inputs.order}}"
    code: |
      const items = input.order.items;
      const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // Calculate shipping based on method
      const shippingRates = {
        standard: 5.99,
        express: 14.99,
        overnight: 29.99
      };
      const shipping = shippingRates[input.order.shippingMethod] || 5.99;
      
      // Calculate tax (assume 8.5% for CA)
      const taxRate = input.order.shippingAddress.state === 'CA' ? 0.085 : 0.07;
      const tax = subtotal * taxRate;
      
      const total = subtotal + shipping + tax;
      
      console.log('Order calculation:', { subtotal, shipping, tax, total });
      
      return {
        subtotal: Math.round(subtotal * 100) / 100,
        shipping: Math.round(shipping * 100) / 100,
        tax: Math.round(tax * 100) / 100,
        total: Math.round(total * 100) / 100,
        itemCount: items.reduce((sum, item) => sum + item.quantity, 0)
      };

  # Step 3: Check inventory for all items (simulated)
  - id: check_inventory
    type: code
    dependsOn: ["calculate_totals"]
    input:
      items: "{{inputs.order.items}}"
    code: |
      // Simulated inventory database
      const inventory = {
        'PROD-001': { available: 50, reserved: 5 },
        'PROD-002': { available: 200, reserved: 10 },
        'PROD-003': { available: 0, reserved: 0 }
      };
      
      const results = input.items.map(item => {
        const stock = inventory[item.sku] || { available: 0, reserved: 0 };
        const availableQty = stock.available - stock.reserved;
        return {
          sku: item.sku,
          name: item.name,
          requested: item.quantity,
          available: availableQty,
          inStock: availableQty >= item.quantity
        };
      });
      
      const allAvailable = results.every(r => r.inStock);
      
      console.log('Inventory check:', allAvailable ? 'All items available' : 'Some items unavailable');
      
      return {
        items: results,
        allAvailable,
        checkedAt: new Date().toISOString()
      };

  # Step 4: Reserve inventory
  - id: reserve_inventory
    type: code
    dependsOn: ["check_inventory"]
    when: "{{step.check_inventory.result.allAvailable}} == true"
    input:
      orderId: "{{inputs.order.orderId}}"
      items: "{{inputs.order.items}}"
    code: |
      // Simulate inventory reservation
      const reservationId = 'RES-' + Date.now();
      
      const reservations = input.items.map(item => ({
        sku: item.sku,
        quantity: item.quantity,
        reservationId,
        expiresAt: new Date(Date.now() + 15 * 60 * 1000).toISOString() // 15 min hold
      }));
      
      console.log('Inventory reserved:', reservationId);
      
      return {
        reservationId,
        orderId: input.orderId,
        reservations,
        reservedAt: new Date().toISOString()
      };

  # Step 5: Process payment (simulated)
  - id: process_payment
    type: code
    dependsOn: ["reserve_inventory"]
    input:
      order: "{{inputs.order}}"
      totals: "{{step.calculate_totals.result}}"
    code: |
      // Simulate payment processing
      const transactionId = 'TXN-' + Date.now();
      
      console.log('Processing payment:', transactionId);
      console.log('Amount:', input.totals.total);
      
      return {
        transactionId,
        status: 'completed',
        amount: input.totals.total,
        cardLast4: input.order.paymentMethod.cardLast4,
        processedAt: new Date().toISOString()
      };

  # Step 6: Log payment success
  - id: log_payment
    activity: log
    dependsOn: ["process_payment"]
    input:
      message: "Payment processed successfully"
      level: "info"
      data:
        orderId: "{{inputs.order.orderId}}"
        amount: "{{step.calculate_totals.result.total}}"
        transactionId: "{{step.process_payment.result.transactionId}}"

  # Step 7: Create shipping label (simulated)
  - id: create_shipping_label
    type: code
    dependsOn: ["process_payment"]
    input:
      order: "{{inputs.order}}"
    code: |
      // Simulate shipping label creation
      const trackingNumber = 'TRK' + Date.now().toString().slice(-10);
      const carriers = {
        standard: 'USPS',
        express: 'FedEx',
        overnight: 'UPS'
      };
      
      const label = {
        trackingNumber,
        carrier: carriers[input.order.shippingMethod] || 'USPS',
        labelUrl: 'https://shipping.example.com/labels/' + trackingNumber + '.pdf',
        estimatedDelivery: new Date(Date.now() + (input.order.shippingMethod === 'overnight' ? 1 : input.order.shippingMethod === 'express' ? 3 : 7) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        createdAt: new Date().toISOString()
      };
      
      console.log('Shipping label created:', trackingNumber);
      
      return label;

  # Step 8: Transform order data for warehouse
  - id: prepare_warehouse_order
    activity: transform
    dependsOn: ["create_shipping_label"]
    input:
      data:
        order: "{{inputs.order}}"
        totals: "{{step.calculate_totals.result}}"
        shipping: "{{step.create_shipping_label.result}}"
        payment: "{{step.process_payment.result}}"
      operations:
        - type: pick
          config:
            fields: ["order", "shipping"]

  # Step 9: Submit to warehouse (simulated)
  - id: submit_to_warehouse
    type: code
    dependsOn: ["prepare_warehouse_order"]
    input:
      warehouseData: "{{step.prepare_warehouse_order.result.data}}"
      orderId: "{{inputs.order.orderId}}"
    code: |
      // Simulate warehouse submission
      const warehouseOrderId = 'WH-' + Date.now();
      
      console.log('Submitted to warehouse:', warehouseOrderId);
      
      return {
        warehouseOrderId,
        orderId: input.orderId,
        status: 'ready_to_ship',
        priority: 'high',
        submittedAt: new Date().toISOString()
      };

  # Step 10: Send order confirmation email
  - id: send_confirmation_email
    activity: email
    dependsOn: ["process_payment"]
    input:
      to: "{{inputs.customerEmail}}"
      subject: "Order Confirmed - {{inputs.order.orderId}}"
      body: |
        <h1>Thank You for Your Order!</h1>
        <p>Order Number: <strong>{{inputs.order.orderId}}</strong></p>
        
        <h2>Order Summary</h2>
        <p>Subtotal: ${{step.calculate_totals.result.subtotal}}</p>
        <p>Shipping: ${{step.calculate_totals.result.shipping}}</p>
        <p>Tax: ${{step.calculate_totals.result.tax}}</p>
        <p><strong>Total: ${{step.calculate_totals.result.total}}</strong></p>
        
        <h2>Shipping Address</h2>
        <p>{{inputs.order.shippingAddress.street}}<br>
        {{inputs.order.shippingAddress.city}}, {{inputs.order.shippingAddress.state}} {{inputs.order.shippingAddress.zip}}</p>
        
        <p>You will receive tracking information once your order ships.</p>

  # Step 11: Wait for shipment confirmation signal
  - id: await_shipment
    type: signal
    dependsOn: ["submit_to_warehouse"]

  # Step 12: Send shipping notification
  - id: send_shipping_notification
    activity: email
    dependsOn: ["await_shipment"]
    input:
      to: "{{inputs.customerEmail}}"
      subject: "Your Order Has Shipped - {{inputs.order.orderId}}"
      body: |
        <h1>Your Order is On Its Way!</h1>
        <p>Great news! Your order has been shipped.</p>
        
        <p><strong>Tracking Number:</strong> {{step.create_shipping_label.result.trackingNumber}}</p>
        <p><strong>Carrier:</strong> {{step.create_shipping_label.result.carrier}}</p>
        <p><strong>Estimated Delivery:</strong> {{step.create_shipping_label.result.estimatedDelivery}}</p>

  # Step 13: Log order completion
  - id: log_order_complete
    activity: log
    dependsOn: ["send_shipping_notification"]
    input:
      message: "Order fulfillment completed"
      level: "info"
      data:
        orderId: "{{inputs.order.orderId}}"
        trackingNumber: "{{step.create_shipping_label.result.trackingNumber}}"
        totalAmount: "{{step.calculate_totals.result.total}}"
